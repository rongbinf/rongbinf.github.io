<!DOCTYPE html>

<html lang="zh-Hans"  dir="ltr"

>

<head>
  <title class="p-name">On SaaS - Rongbin&#39;s Blog</title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">
<meta name="description"
    content="Assume that you know nothing about SaaS. What&#39;s SaaS? ">
<meta name="author p-author" content="Rongbin FAN" href="https://fanrongbin.com">

<meta property="og:title" content='On SaaS - Rongbin&#39;s Blog' />
<meta property="og:description" content="Assume that you know nothing about SaaS. What&#39;s SaaS? " />
<meta property="og:url" content="https://fanrongbin.com/on-saas/" />
<meta property="og:image" content="https://fanrongbin.com/apple-touch-icon.png" />

<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:image" content="https://fanrongbin.com/apple-touch-icon.png" />
<meta name="twitter:title" content='On SaaS - Rongbin&#39;s Blog' />
<meta name="twitter:description" content="Assume that you know nothing about SaaS. What&#39;s SaaS? " />

<link rel="canonical" href="https://fanrongbin.com/on-saas/" />






      <link rel="stylesheet" href="/css/main.min.7154fca98a197f082c4a1ebc1e6ac393acd86e4855b1bd5fe96cdc9e33524de8.css" integrity="sha256-cVT8qYoZfwgsSh68HmrDk6zYbkhVsb1f6WzcnjNSTeg=" crossorigin="anonymous">

<link rel="stylesheet" href="/han.min.css" type="text/css">





<link rel="alternate" type="application/activity+json" href="https://fed.brid.gy/r/https://fanrongbin.com/on-saas/">

<link rel="webmention" href="https://webmention.io/fanrongbin.com/webmention" />

<script data-goatcounter="https://ron.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script>
</head>

<body class="han-init-context">

  <section class="navbar">
    <span class="header-name">
    <a href="/" class="header-link h-card p-name p-author u-url u-uid">Rongbin FAN</a>
     / <a href="/posts" class="header-link">Blog</a>
    <br>
    <a href="/stream" class="header-link header-guestbook">ϟ Stream</a>
    
    <a href="/links" class="header-link header-guestbook">◩ Guestbook</a>
    
</span>


  </section>

  <article class="article-entry h-entry">
      

<section class="content-header">

  <div class="top-scroll-bar"></div>
<div class="addn visible">
<a onclick="showHypo()" style="color:var(--textcolor);text-decoration:none;border:none;"><div id="show-hypo" class="header-button no-select">Hypothes.is</div></a>
<a onclick="toggleTOC()" style="color:var(--textcolor);text-decoration:none;border:none;"><div id="contents-fixed" class="header-button no-select">Contents</div></a>
</div>
<div id="contents-toc" class="no-select">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#firstly-it-is-a-business-model">Firstly, it is a business model.</a></li>
        <li><a href="#what-does-it-mean-by-not-owning-the-software">What does it mean by not owning the software?</a></li>
        <li><a href="#saas-doesnt-work-like-traditional-software-business">SaaS doesn&rsquo;t work like traditional software business.</a></li>
        <li><a href="#so-these-are-the-fundamentals-of-saas-business">So, these are the fundamentals of SaaS business:</a></li>
        <li><a href="#why-do-people-like-saas">Why do people like SaaS?</a></li>
        <li><a href="#why-does-the-traditional-software-industry-shift-to-saas">Why does the traditional software industry shift to SaaS?</a></li>
        <li><a href="#but-its-not-perfect-what-if-people-stop-subscribing">But it&rsquo;s not perfect: what if people stop subscribing?</a></li>
        <li><a href="#therefore-saas-has-the-following-differences-from-traditional-software-in-financials">Therefore, SaaS has the following differences from traditional software in financials:</a></li>
        <li><a href="#and-also-these-key-metrics">And also these key metrics:</a></li>
        <li><a href="#lastly-lets-talk-about-the-future-it-depends-on">Lastly, let&rsquo;s talk about the future. It depends on:</a></li>
        <li><a href="#last-questions">Last questions:</a></li>
      </ul>
    </li>
  </ul>
</nav>
</div>

  

  <div id="single-header">
    <h1 class="p-name content-h1">On SaaS</h1>
    

    
      
      
      
        
        <p class="content-time"><time class="dt-published" datetime="2024-03-18T21:03:00&#43;08:00">18 March 2024</time></p>
        
      
    

    <a rel="author" class="p-name h-card" href="https://fanrongbin.com" style="display:none;">Rongbin Fan</a>
  </div>

  

</section>





<style>
  .navbar, footer, .footer-nav, .webmentions-how, .comment-box, .comment-title {
    opacity: 0.35 !important;
  }
  .navbar:hover, footer:hover, .footer-nav:hover, .webmentions-how:hover, .comment-box:hover {
    opacity: 1 !important;
  }
</style>



<div class="link-display"></div>


      
      <p class="p-summary" style="display:none;">Assume that you know nothing about SaaS. What&#39;s SaaS?</p>
      
      <main class="e-content">
      
      














    

    

    

    

<div class="callout ">
    <div></div>
      <div class="callout-inner">
      <p><strong>tl;dr:</strong> SaaS (Software as a Service) is all about standardised products and services that&rsquo;ll bring corresponding growth in high gross profit.</p>
<ul>
<li>SaaS business:
<ul>
<li><strong>Subscription-based</strong> purchasing</li>
<li>Selling <em>the right to enjoy services</em>
<ul>
<li>What services: <strong>tiered pricing, on-demand pricing</strong></li>
<li>Rights can be expired: expiration</li>
</ul>
</li>
<li>Software is not running in your local servers: <strong>web-based standardised</strong> products</li>
</ul>
</li>
<li>What&rsquo;s good:
<ul>
<li>cheap, and flexible to raise demands or opt-out</li>
<li>significant cash flow for vendors, creates elastic sales strategies, and has substantial economies of scale based on standardised features</li>
</ul>
</li>
<li>Churn is the <em>key</em> problem:
<ul>
<li>easy replacement</li>
<li>weak features squeezing clients heading towards customisation</li>
<li>security concerns (most SaaS run on clouds)</li>
</ul>
</li>
<li>Metrics:
<ul>
<li>retention/churn/conversion</li>
<li>average revenue/cost, LTV/CAC</li>
</ul>
</li>
<li>What&rsquo;s the future?
<ul>
<li>client understanding</li>
<li>trends in industries and management acceptance</li>
<li>performance of clients themselves</li>
<li>next variation of the real economy to drive digitalisation</li>
<li>discovery of niches at the intersection of markets</li>
</ul>
</li>
<li>Last questions:
<ul>
<li>Do we have the <em>moat</em>?</li>
<li>Have we known the clients well enough? What do they all want?</li>
<li>They want this and that. What&rsquo;s the link between this and that? Have we modelled and refined the abstract business operating logic?</li>
<li>Have we covered every node on the workflow by standardised feature legos?</li>
</ul>
</li>
</ul>
    </div>
  </div>
<p>Assume that you know nothing about SaaS.</p>
<h3 id="firstly-it-is-a-business-model">
Firstly, it is a business model.
<a href="#firstly-it-is-a-business-model" class="heading-anchor">#</a>
</h3>
<p>Its full name is <em>Software as a Service</em>. So there are two key concepts:</p>
<ul>
<li>Software: clients are using a computer programme</li>
<li>Service: clients do not own this software, only enjoying the rights to use the software</li>
</ul>
<h3 id="what-does-it-mean-by-not-owning-the-software">
What does it mean by not owning the software?
<a href="#what-does-it-mean-by-not-owning-the-software" class="heading-anchor">#</a>
</h3>
<ul>
<li>The traditional software industry providing standardised software like Microsoft Office or Adobe Photoshop from the early 21st century, is based on selling software discs and serial numbers off the shelves in supermarkets.
<ul>
<li>Vendors only provide basic operational services after, including activation hotlines and installation documents. We often need a handbook titled &ldquo;Mastering Excel&rdquo; to learn how to use the software, and companies often need to hire specialised talents.</li>
<li>After purchasing the disc or license, we can use this software until the world ends.</li>
</ul>
</li>
<li>The traditional software industry providing non-standardised software by customisation (for enterprise users, of course), such as developing an expense tracking system to record invoices and cross-verify with the company&rsquo;s policy, is based on the customisation contracts:
<ul>
<li>where software features, the cost of later maintenance and the time span (usually for the next five to ten years) have been agreed upon. Fees on maintenance are pre-priced and pre-paid, and basically do not involve changes and updates in features and the operation logic.</li>
<li>After signing the contract and having the customised software delivered, enterprises can use the software until the world ends, too. But if there&rsquo;s any new need arises (for example, the company wants to integrate a built-in Booking.com or Agoda so employees can book hotels within), it must be conducted by signing another new contract to develop a new customised software.</li>
</ul>
</li>
</ul>
<h3 id="saas-doesnt-work-like-traditional-software-business">
SaaS doesn&rsquo;t work like traditional software business.
<a href="#saas-doesnt-work-like-traditional-software-business" class="heading-anchor">#</a>
</h3>
<ul>
<li>Clients use the software continuously by subscribing to pay the service provider periodically for months or years.</li>
<li>What clients have is only the right to use the software during the billing period, and to enjoy any corresponding services and software updates.</li>
<li>Clients do not have access to any source code, which also means that the software maintenance can only be done by SaaS providers instead of in-house IT.</li>
</ul>
<h3 id="so-these-are-the-fundamentals-of-saas-business">
So, these are the fundamentals of SaaS business:
<a href="#so-these-are-the-fundamentals-of-saas-business" class="heading-anchor">#</a>
</h3>
<ul>
<li><strong>Subscription-based</strong> purchasing</li>
<li>Selling <em>the right to enjoy services</em>
<ul>
<li>What services: <strong>tiered pricing, on-demand pricing</strong></li>
<li>Rights can be expired: expiration</li>
</ul>
</li>
<li>Software is not running in your local servers: <strong>web-based standardised</strong> products</li>
</ul>
<h3 id="why-do-people-like-saas">
Why do people like SaaS?
<a href="#why-do-people-like-saas" class="heading-anchor">#</a>
</h3>
<ul>
<li>It&rsquo;s cheaper:
<ul>
<li>compared to customisation</li>
<li>and it&rsquo;s cost-effective by leveraging public clouds (storing your data on tech companies&rsquo; servers so you don&rsquo;t need to buy IT infra)</li>
</ul>
</li>
<li>It&rsquo;s flexible:
<ul>
<li>More add-ons</li>
<li>Possible to raise new demands and opt-out at any time</li>
</ul>
</li>
</ul>
<h3 id="why-does-the-traditional-software-industry-shift-to-saas">
Why does the traditional software industry shift to SaaS?
<a href="#why-does-the-traditional-software-industry-shift-to-saas" class="heading-anchor">#</a>
</h3>
<ul>
<li>It provides continuous cash flow through subscription.</li>
<li>It creates elastic sales and marketing strategies by packaging different features.</li>
<li>It has substantial economies of scale as providers develop software features one time but sell them to everyone.</li>
</ul>
<h3 id="but-its-not-perfect-what-if-people-stop-subscribing">
But it&rsquo;s not perfect: what if people stop subscribing?
<a href="#but-its-not-perfect-what-if-people-stop-subscribing" class="heading-anchor">#</a>
</h3>
<ul>
<li>Maybe it&rsquo;s because of intense competition: too many competitors want to solve similar problems within similar scenarios. They simply can replace one another which leads to a price war.</li>
<li>Maybe it&rsquo;s because of a weak supply: too few vendors can satisfy customer needs and customers often have tricky business workflow. They rather go with customisation.</li>
<li>Maybe it&rsquo;s because of specific security and compliance requirements, necessitating data being stored or handled locally on self-hosted servers.</li>
</ul>
<h3 id="therefore-saas-has-the-following-differences-from-traditional-software-in-financials">
Therefore, SaaS has the following differences from traditional software in financials:
<a href="#therefore-saas-has-the-following-differences-from-traditional-software-in-financials" class="heading-anchor">#</a>
</h3>
<ul>
<li>More SG&amp;A (especially sales) expenses and headcounts</li>
<li>The size of products/development team is much bigger than delivery/implement team</li>
</ul>
<h3 id="and-also-these-key-metrics">
And also these key metrics:
<a href="#and-also-these-key-metrics" class="heading-anchor">#</a>
</h3>
<ul>
<li>Retention, churn, conversion</li>
<li>Average revenue and cost of customer acquisition
<ul>
<li>MRR, ARR, ARPU</li>
<li>LTV/CAC</li>
</ul>
</li>
</ul>
<h3 id="lastly-lets-talk-about-the-future-it-depends-on">
Lastly, let&rsquo;s talk about the future. It depends on:
<a href="#lastly-lets-talk-about-the-future-it-depends-on" class="heading-anchor">#</a>
</h3>
<ul>
<li>How well do vendors understand their clients: becoming a must in their clients&rsquo; needs
<ul>
<li>See the core of businesses with clients, and position</li>
<li>Grow with peers: SaaS is bound to be transformed into PaaS (Platform as a service)</li>
</ul>
</li>
<li>Trends in industries and management acceptance
<ul>
<li>Digitalisation?</li>
</ul>
</li>
<li>How well do clients perform themselves: are they themselves gonna die soon?
<ul>
<li>It&rsquo;s where the money from.</li>
</ul>
</li>
<li>The best moments and how quickly vendors act
<ul>
<li>Take the pandemic and the video conference market as an example.</li>
<li>Question: what&rsquo;s the next chapter of the evolution/variation of the real economy that will become the driver of digitalisation?</li>
</ul>
</li>
<li>The discovery of small niches at the intersection of markets
<ul>
<li>SaaS is no longer a novel concept and is already a relatively mature business model you see everywhere. It&rsquo;s getting old. The valuation tools for SaaS are also mature, mainly using P/S with a closer look at the pure SaaS part from customisation and consulting solutions.</li>
<li>And it&rsquo;s no longer an interesting topic for investments (while not using SaaS seems to be more interesting nowadays. Consider industrial software.) and exits mostly rely on hopes of being acquired by major tech companies so they can blend themselves within their ecosystems.</li>
</ul>
</li>
</ul>
<p>Fundamentally, <strong>SaaS is all about standardised products and services that&rsquo;ll bring corresponding growth in high gross profit.</strong></p>
<h3 id="last-questions">
Last questions:
<a href="#last-questions" class="heading-anchor">#</a>
</h3>
<ul>
<li>Do we have the <em>moat</em>?</li>
<li>Have we known the clients well enough? What do they all want?</li>
<li>They want this and that. What&rsquo;s the link between this and that? Have we modelled and refined the abstract business operating logic?</li>
<li>Have we covered every node on the workflow by standardised feature legos?</li>
</ul>



          
      
          <a class="u-url" href="https://fanrongbin.com/on-saas/" hidden="from-humans" style="display:none;"></a>
      

      </main>
      
      
      <a class="u-bridgy-fed" rel="bridgy" href="https://fed.brid.gy/" hidden="from-humans" style="display:none;"></a>

  
  </article>
  

  
  



<div class="footer-nav">




<div class="previous-post" style="display:inline-block;">
  
    
      <a class="no-external" href="/hugo-markdownify-generate-p-tag/"><span class="arrow">←</span> Hugo Markdownify 无法生成 &lt;p&gt; tag</a>
    
  
</div>




  <div class="Tags">
    <ul style="list-style-type: none;margin:0;">
      <li class="label">TAGS</li>
        <li><a href="/tags/on/">On</a></li>
    </ul>
  </div>

<div class="next-post" style="display:inline-block;float:right;">
  
    
      <a class="no-external" href="/on-reddit-ipo/">On Reddit IPO <span class="arrow">→</span></a>
    
  
</div>

</div>






  

<h2 class="comment-title">Comment</h2>

<details class="comment-box">
  <summary>Login via Github</summary>
<div id="giscus">
  <script id="giscus-script" src="https://giscus.app/client.js" data-repo="rongbinf/giscus-comment"
      data-repo-id="R_kgDOK3UYzw" data-category="Announcements"
      data-category-id="DIC_kwDOK3UYz84Cbl2R" data-mapping="pathname" data-strict="0"
      data-reactions-enabled="0" data-emit-metadata="0" data-input-position="top"
      data-theme="https://fanrongbin.com/giscus.css" data-lang="en" data-loading="lazy"
      crossorigin="anonymous" defer>
      </script>
</div>
</details>


<details class="comment-box">
  <summary>No Login</summary>
  <div id="tcomment"></div>
  <script src="https://cdn.jsdelivr.net/npm/twikoo@1.6.36/dist/twikoo.all.min.js" integrity="sha384-4KfOjEinLSkv1i1J8TzlkC/RTnuiLoR1OLerVgjEKoH5djYtbf7mzEFsz9p3nfuA" crossorigin="anonymous" onload="initTwikoo()" defer></script>
  <script>
  function initTwikoo() {
    twikoo.init({
      envId: 'https://twikoo.fanrongbin.com',
      el: '#tcomment',
      lang: 'en',
    });
  }
  </script>
  <style>
    .twikoo svg{
      margin: 0;
    }
    .tk-avatar .tk-avatar-img {
      margin: 0;
    }
    .el-input-group__append, .el-input-group__prepend {
      background-color: unset !important;
      border: unset !important;
    }
    .el-input__inner, .el-textarea__inner {
      border: 0;
      border-bottom: 1px solid var(--text-color);
      border-radius: 0;
    }
    .el-input.is-active .el-input__inner, .el-input__inner:focus,
    .twikoo .el-input__inner:focus, .twikoo .el-textarea__inner:focus {
      border-color: var(--text-color) !important;
    }
    .el-button--primary {
      background-color: var(--highlight) !important;
    }
    .el-button--primary.is-disabled {
      background-color: var(--highlight) !important;
      border: 0 !important;
      opacity: 0.5 !important;
    }
    .twikoo .el-button:not(.el-button--primary):not(.el-button--text):hover {
      border-color: white !important;
      background-color: var(--highlight) !important;
      color: white !important;
    }
    .tk-submit-action-icon.__markdown {
      border: none;
    }
    .tk-submit-action-icon.__markdown::after {
      content: none;
    }
    .tk-icon.__comments {
      color: var(--highlight);
    }
  </style>
</details>

<details class="comment-box">
  <summary>Webmention</summary>
  <script src="/webmention.min.js" defer></script>
  <div id="webmentions"></div>
  <div>
    <p>
      
      What is <a
    href="/hugo-webmention-bridgy-mastodon">Webmention</a>?</p>
    <form class="webmention-form" action="https://webmention.io/fanrongbin.com/webmention" method="post" style="margin: 2ch 0;">
          <input type="url" name="source" class="url" placeholder="Your URL" required="">
          <input type="hidden" name="target" value="https://fanrongbin.com/on-saas/">
          <input type="submit" value="Send" style="background:var(--bg-color);">
    </form>
  </div>
</details>

<details class="comment-box" onclick="showHypo();">
  <summary><a id="commenthypo" onclick="showHypo();">Hypothes.is</a></summary>
  </details>



  

  <footer class="opacity-6">
    <p><a href="/colophon">Colophon</a></p><p><a href="https://creativecommons.org/licenses/by-sa/4.0/" target="_blank">CC BY-SA 4.0</a></p>
  </footer>

</body>

<script src="/han.min.js" defer></script>



<script type="application/json" class="js-hypothesis-config" defer>
{
    "sideBySide": {
        "mode": "manual"
    }
}
</script>

<script defer>
    var mainElement = document.querySelector('main');
    var contentHeader = document.querySelector('section.content-header');
    const headers = mainElement.querySelectorAll('h2, h3');
    document.addEventListener('DOMContentLoaded', function () {

        if (contentHeader) {
            contentHeader.querySelector('#show-hypo').style.display = 'flex';
        }

        handleScrollEvents();

        applyBreakAllClass();

        setupSidenotes();

        initializeMutationObserver();

        initializeTOCFeatures();

        preventMultiTouchGestures();

        setExternalLinksToOpenInNewTab();
    });

    function updateHHangableBehavior() {
        var sidenoteHangables = mainElement.querySelectorAll('.sidenote-number + h-hangable');
        sidenoteHangables.forEach(function (hHangable) {
            var sidenoteNumber = hHangable.previousElementSibling;
            var sidenoteBox = sidenoteNumber.querySelector('.sidenote-box');
            if (sidenoteBox) {
                sidenoteNumber.insertBefore(hHangable, sidenoteBox);
            }
        });
    }

    function initializeMutationObserver() {
        var observer = new MutationObserver(function (mutations) {
            var shouldUpdate = false;
            mutations.forEach(function (mutation) {
                mutation.addedNodes.forEach(function (node) {
                    if (node.nodeType === 1 && node.matches('h-hangable')) {
                        var previousSibling = node.previousElementSibling;
                        if (previousSibling && previousSibling.matches('.sidenote-number')) {
                            shouldUpdate = true;
                        }
                    }
                });
            });
            if (shouldUpdate) {
                setTimeout(updateHHangableBehavior, 1200);
            }
        });

        var config = { childList: true, subtree: true };
        if (mainElement) {
            observer.observe(mainElement, config);
        }
    }

    function applyBreakAllClass() {
        var screenWidth = window.innerWidth || document.documentElement.clientWidth || document.body.clientWidth;
        var codeElements = mainElement.querySelectorAll('code');

        codeElements.forEach(function (element) {
            if (screenWidth <= 960) {
                if (element.textContent.length > 10) {
                    element.classList.add('break-all');
                }
            }
            else {
                if (element.textContent.length > 30) {
                    element.classList.add('break-all');
                }
            }
        });
    }

    function handleScrollEvents() {
        if (contentHeader) {
            let lastScrollTop = 0;
            let isScrolling = false;
            const addnDiv = contentHeader.querySelector('.addn');
            const topScrollBar = contentHeader.querySelector('.top-scroll-bar');

            window.addEventListener('scroll', function () {
                const currentScroll = window.pageYOffset || document.documentElement.scrollTop;
                if (!isScrolling) {
                    window.requestAnimationFrame(function () {
                        if (topScrollBar) {
                            const scrollPercent = (currentScroll / (document.documentElement.scrollHeight - window.innerHeight)) * 100;
                            topScrollBar.style.width = scrollPercent + '%';
                            topScrollBar.style.display = 'block';
                        }
                        if (addnDiv) {
                            if (currentScroll > lastScrollTop && currentScroll > 50) {
                                addnDiv.classList.remove('visible');
                            } else {
                                addnDiv.classList.add('visible');
                            }
                        }
                        lastScrollTop = currentScroll <= 0 ? 0 : currentScroll;
                        isScrolling = false;
                    });
                    isScrolling = true;
                }
                if (window.innerWidth >= 1600) {
                    toggleTOCOnScroll();
                }
            }, false);
        }
    }

    function showHypo() {
        var existingScript = document.getElementById('hypothes-script');
        var button = contentHeader.querySelector('#show-hypo');

        var commentHypo = document.getElementById("commenthypo");

        if (!existingScript) {
            button.textContent = 'Loading';
            commentHypo.textContent = 'Loading'

            var script = document.createElement('script');
            script.id = 'hypothes-script';
            script.src = 'https://hypothes.is/embed.js';

            script.onload = () => {
                button.textContent = 'Hypothes.is';
                commentHypo.textContent = 'You can now select texts to highlight or note.'
            };

            script.onerror = () => {
                button.style.color = 'red';
                button.textContent = 'Failed';
                commentHypo.textContent = 'Network error. Please refresh and try again.'
            };

            
            document.body.appendChild(script);
        } else {
            toggleHypothesisElementsVisibility();
            button.style.color = 'var(--text-color)';
        }
    }

    function toggleHypothesisElementsVisibility() {
        const elementsToToggle = [
            'hypothesis-sidebar',
            'hypothesis-notebook',
            'hypothesis-profile',
            'hypothesis-adder',
            'hypothesis-highlight-cluster-toolbar'
        ];

        elementsToToggle.forEach(function (element) {
            var el = document.querySelector(element);
            if (el) {
                if (el.style.display === 'none') {
                    el.style.display = '';
                } else {
                    el.style.display = 'none';
                }
            }
        });
    }


    function initializeTOCFeatures() {
        if (contentHeader) {
            const contentsFixedDiv = contentHeader.querySelector('#contents-fixed');
            const tocContainer = contentHeader.querySelector('#contents-toc');
            if (contentsFixedDiv && headers.length > 1) {
                contentsFixedDiv.style.display = 'flex';
                contentsFixedDiv.addEventListener('click', (event) => {
                    toggleTOC();
                    event.stopPropagation();
                });
            }
            if (tocContainer && !tocContainer.dataset.initialized) {
                const throttledHighlight = throttle(highlightAppropriateHeader, 250);
                window.addEventListener('scroll', throttledHighlight);
                tocContainer.dataset.initialized = 'true';
            }
        }
    }

    function highlightAppropriateHeader() {
        let highlightedHeader = null;
        let foundHeaderInView = false;

        
        for (let i = 0; i < headers.length; i++) {
            const header = headers[i];
            const bounding = header.getBoundingClientRect();

            if (bounding.top >= 0 && bounding.bottom <= window.innerHeight) {
                highlightedHeader = header; 
                foundHeaderInView = true;
                break;
            }
        }

        
        if (!foundHeaderInView) {
            for (let i = 0; i < headers.length; i++) {
                const header = headers[i];
                let nextHeader = headers[i + 1];
                let endOfSection = nextHeader ? nextHeader.getBoundingClientRect().top : Infinity;

                const startOfSection = header.getBoundingClientRect().bottom;

                if (startOfSection < window.innerHeight && endOfSection > 0) {
                    highlightedHeader = header;
                    break;
                }
            }
        }

        
        contentHeader.querySelectorAll('nav#TableOfContents a').forEach(link => {
            link.classList.remove('toc-highlight');
        });

        
        if (highlightedHeader) {
            const link = contentHeader.querySelector(`nav#TableOfContents a[href="#${highlightedHeader.id}"]`);
            if (link) {
                link.classList.add('toc-highlight');
            }
        }
    }

    function toggleTOC() {
        const tocContainer = contentHeader.querySelector('#contents-toc');
        const isDisplayed = window.getComputedStyle(tocContainer).display !== 'none';
        tocContainer.style.display = isDisplayed ? 'none' : 'flex';
    }

    function toggleTOCOnScroll() {
        const tocContainer = document.querySelector('#TableOfContents');
        const footerNav = document.querySelector('.footer-nav');

        if (!tocContainer || !footerNav) return;

        const footerNavTop = footerNav.getBoundingClientRect().top;
        const windowHeight = window.innerHeight;

        
        if (footerNavTop <= windowHeight) {
            tocContainer.style.display = 'none';
        } else {
            tocContainer.style.display = 'flex';
        }
    }

    function throttle(func, limit) {
        let lastFunc;
        let lastRan;
        return function () {
            const context = this;
            const args = arguments;
            if (!lastRan) {
                func.apply(context, args);
                lastRan = Date.now();
            } else {
                clearTimeout(lastFunc);
                lastFunc = setTimeout(function () {
                    if ((Date.now() - lastRan) >= limit) {
                        func.apply(context, args);
                        lastRan = Date.now();
                    }
                }, limit - (Date.now() - lastRan));
            }
        }
    }

    function setExternalLinksToOpenInNewTab() {
        const links = document.querySelectorAll('.e-content a[href*="//"]:not(.stream-url):not(.stream-time)');
        const linkDisplay = document.querySelector('.link-display');

        links.forEach(function (link) {
            link.setAttribute('target', '_blank');

            link.addEventListener('mouseover', function () {
                const url = new URL(this.href);
                const rootDomain = url.hostname.replace(/^www\./, '');
                const boldDomain = `<span class="bold-domain">${rootDomain}</span>`;
                const displayUrl = this.href.replace(rootDomain, boldDomain);

                linkDisplay.innerHTML = displayUrl;
                linkDisplay.style.display = 'block';
                const linkRect = this.getBoundingClientRect();
                linkDisplay.style.top = `${linkRect.bottom + window.scrollY}px`;
                linkDisplay.style.left = `${linkRect.left + window.scrollX}px`;
            });

            link.addEventListener('mouseout', function () {
                linkDisplay.style.display = 'none';
            });
        });
    }

    function setupSidenotes() {
    const sidenoteNumbers = mainElement.querySelectorAll('.sidenote-number');

    if (sidenoteNumbers.length >= 3 && window.innerWidth >= 1000) {
        const sidenoteLine = mainElement.querySelectorAll('.sidenote-line');
        sidenoteLine.forEach(element => {
            element.style.border = 'none';
        });

        var jQueryScript = document.createElement('script');
        jQueryScript.src = '/jquery-3.6.0.min.js';
        document.head.appendChild(jQueryScript);

        jQueryScript.onload = function () {
            var jsPlumbScript = document.createElement('script');
            jsPlumbScript.src = '/jsplumb.min.js';
            document.head.appendChild(jsPlumbScript);

            jsPlumbScript.onload = function () {
                initJsPlumb();
            };
        };
    }

    function applySidenoteMargins() {
        const screenWidth = window.innerWidth;

        if (screenWidth <= 1000) {
            sidenoteNumbers.forEach(sidenoteNumber => {
                const sidenoteBox = sidenoteNumber.querySelector('.sidenote-box');
                const afterSidenoteContent = sidenoteNumber.nextSibling;

                if (sidenoteBox) {
                    if (afterSidenoteContent && afterSidenoteContent.textContent.trim() !== "") {
                        sidenoteBox.style.marginBottom = "0"; 
                    }
                }
            });
        } else {
            sidenoteNumbers.forEach(sidenoteNumber => {
                const sidenoteBox = sidenoteNumber.querySelector('.sidenote-box');
                if (sidenoteBox) {
                    sidenoteBox.style.marginBottom = "";  
                }
            });
        }
    }

    applySidenoteMargins();

    window.addEventListener('resize', applySidenoteMargins);
}


    function initJsPlumb() {
        var jsPlumbCSS = document.createElement('link');
        jsPlumbCSS.href = '/jsplumbtoolkit-defaults.min.css';
        jsPlumbCSS.rel = 'stylesheet';
        document.head.appendChild(jsPlumbCSS);

        jQuery(document).ready(function () {
            jsPlumb.importDefaults({
                ConnectionsDetachable: false,
                ReattachConnections: false,
                Endpoint: "Blank",
                Connector: ["Straight"],
                PaintStyle: { stroke: "var(--text-color)", strokeWidth: 1 }
            });

            createConnections();
            var resizeObserver = new ResizeObserver(function () {
                createConnections();
            });
            resizeObserver.observe(document.body);
        });
    }

    function createConnections() {
        jsPlumb.deleteEveryEndpoint();
        jQuery('.sidenote-number').each(function () {
            var sidenoteNumber = jQuery(this);
            var sidenote = sidenoteNumber.find('.sidenote');

            if (sidenote.length) {
                jsPlumb.connect({
                    source: sidenoteNumber[0],
                    target: sidenote[0],
                    anchors: ["Center", "RightMiddle"],
                    cssClass: "jsplumb-line"
                });
            }
        });
    }


    function preventMultiTouchGestures() {
        window.onload = function () {
            document.addEventListener('touchstart', function (event) {
                if (event.touches.length > 1) {
                    event.preventDefault();
                }
            }, false);
            var lastTouchEnd = 0;
            document.addEventListener('touchend', function (event) {
                var now = (new Date()).getTime();
                if (now - lastTouchEnd <= 300) {
                    event.preventDefault();
                }
                lastTouchEnd = now;
            }, false);
            document.addEventListener('gesturestart', function (event) {
                event.preventDefault();
            }, false);
        }
    }
</script>

</html>